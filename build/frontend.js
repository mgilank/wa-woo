jQuery(document).ready((function(e){console.log("WhatsApp Checkout script loaded"),e(document).on("click",".wp-block-wa-checkout-button",(function(t){t.preventDefault(),console.log("WhatsApp button clicked");var o=e(this),a=o.data("wa-link"),s=o.data("wa-message"),n={billing:{},shipping:{},shipping_method:"",payment_method:""},c=!0,i="",r=[],h=["first_name","last_name","address_1","city","state","postcode"],p=["first_name","last_name","address_1","city","state","postcode"];if(e("form.checkout").length){console.log("Checkout form found, collecting data"),e(".wa-checkout-error").removeClass("wa-checkout-error"),e('form.checkout [name^="billing_"]').each((function(){var t=e(this).attr("name").replace("billing_","");if(n.billing[t]=e(this).val(),h.includes(t)&&!e(this).val().trim()){c=!1,e(this).addClass("wa-checkout-error");var o=t.replace("_"," ");"first_name"===t&&(o="First Name"),"last_name"===t&&(o="Last Name"),"address_1"===t&&(o="Address"),"state"===t&&(o="Province"),"postcode"===t&&(o="Postal Code"),r.push("Billing "+o)}})),e('form.checkout [name^="shipping_"]').each((function(){var t=e(this).attr("name").replace("shipping_","");if(n.shipping[t]=e(this).val(),p.includes(t)&&!e(this).val().trim()){c=!1,e(this).addClass("wa-checkout-error");var o=t.replace("_"," ");"first_name"===t&&(o="First Name"),"last_name"===t&&(o="Last Name"),"address_1"===t&&(o="Address"),"state"===t&&(o="Province"),"postcode"===t&&(o="Postal Code"),r.push("Shipping "+o)}}));var l="",m=!1,d=!0;if("undefined"!=typeof wc_checkout_params&&!0===wc_checkout_params.cart_has_virtual_products_only&&(d=!1),0===e(".woocommerce-shipping-totals").length&&(d=!1),d){var _=e('input[name^="shipping_method"]:checked');_.length?(l=_.val(),m=!0):e("select.shipping_method").length?(l=e("select.shipping_method").val(),m=!0):e('input[name^="shipping_method"][type="hidden"]').length&&(l=e('input[name^="shipping_method"][type="hidden"]').val(),m=!0),l||1!==e(".woocommerce-shipping-methods li").length||(l=e('.woocommerce-shipping-methods input[name^="shipping_method"]').val(),m=!0),!l&&e(".woocommerce-shipping-methods li").length>0&&(c=!1,r.push("Shipping method"))}l?n.shipping_method=l:d&&!m&&"undefined"!=typeof wc_checkout_params&&wc_checkout_params.chosen_shipping_methods&&(n.shipping_method=wc_checkout_params.chosen_shipping_methods[0]||"");var u="",g=!1,f=e('input[name="payment_method"]:checked');f.length?(u=f.val(),g=!0):e('input[name="payment_method"][type="hidden"]').length&&(u=e('input[name="payment_method"][type="hidden"]').val(),g=!0),u||1!==e(".wc_payment_methods li").length||(u=e('.wc_payment_methods input[name="payment_method"]').val(),g=!0),!u&&e(".wc_payment_methods li").length>0&&(c=!1,r.push("Payment method")),u?n.payment_method=u:g||"undefined"!=typeof wc_checkout_params&&wc_checkout_params.chosen_payment_method&&(n.payment_method=wc_checkout_params.chosen_payment_method);var k=e("#order_comments").val();k&&(n.note=k)}else{if(console.log("No checkout form found, trying to get WooCommerce customer data"),"undefined"!=typeof wc_checkout_params){if(wc_checkout_params.customer_details){n.billing=wc_checkout_params.customer_details.billing||{},n.shipping=wc_checkout_params.customer_details.shipping||{};for(var y=0;y<h.length;y++){var w=h[y];if(!n.billing[w]||""===n.billing[w].trim()){c=!1;var v=w.replace("_"," ");"first_name"===w&&(v="First Name"),"last_name"===w&&(v="Last Name"),"address_1"===w&&(v="Address"),"state"===w&&(v="Province"),"postcode"===w&&(v="Postal Code"),r.push("Billing "+v)}}for(y=0;y<p.length;y++)w=p[y],n.shipping[w]&&""!==n.shipping[w].trim()||(c=!1,v=w.replace("_"," "),"first_name"===w&&(v="First Name"),"last_name"===w&&(v="Last Name"),"address_1"===w&&(v="Address"),"state"===w&&(v="Province"),"postcode"===w&&(v="Postal Code"),r.push("Shipping "+v))}else c=!1,i="Please fill in your billing and shipping information before checkout.";d=!0,!0===wc_checkout_params.cart_has_virtual_products_only&&(d=!1),d&&wc_checkout_params.chosen_shipping_methods&&(n.shipping_method=wc_checkout_params.chosen_shipping_methods[0]||"",n.shipping_method||(c=!1,r.push("Shipping method")))}else c=!1,i="Please complete the checkout form before proceeding.";if("undefined"!=typeof wc_checkout_params){var b=!0;if("0"===wc_checkout_params.order_total&&(b=!1),b)if(wc_checkout_params.chosen_payment_method)n.payment_method=wc_checkout_params.chosen_payment_method;else if("object"==typeof wc_checkout_params.available_payment_methods){var P=Object.keys(wc_checkout_params.available_payment_methods).length;1===P?n.payment_method=Object.keys(wc_checkout_params.available_payment_methods)[0]:P>1&&(c=!1,r.push("Payment method"))}else c=!1,r.push("Payment method");else n.payment_method="none"}else c=!1,r.push("Payment method")}if(r.length>0&&(i="Please fill in the following required fields before checkout:\n• "+r.join("\n• ")),console.log("Validation passed:",c),c||console.log("Missing fields:",r),!c)return alert(i),e(".wa-checkout-error").length&&e("html, body").animate({scrollTop:e(".wa-checkout-error").first().offset().top-100},500),!1;o.prop("disabled",!0).text("Processing..."),console.log("Sending AJAX request to save order"),e.ajax({url:waCheckoutFrontend.ajaxUrl,type:"POST",data:{action:"wa_save_order",nonce:waCheckoutFrontend.nonce,message:s,customer:n},success:function(e){console.log("AJAX response:",e),e.success?(console.log("Order saved successfully, ID: "+e.data.order_id),window.open(a,"_blank")):(console.error("Failed to save order:",e.data),alert("Error: "+e.data))},error:function(e,t,o){console.error("AJAX error:",o),alert("Error: Could not process your order. Please try again.")},complete:function(){o.prop("disabled",!1).text("Checkout via WhatsApp")}})})),e("<style>.wa-checkout-error { border: 1px solid red !important; background-color: #fff8f8 !important; }</style>").appendTo("head")}));